# 개발문서

## 결정사항
- 테스트 커버리지 목표: `did/...` 범위에서 95% 이상.
- 커버리지 계산 제외: 외부 의존/생성 코드 성격이 강한 패키지는 제외한다.  
  제외 목록: `did/core/driver`, `did/core/driver/scdid`, `did/c-shared`, `did/service`.
- API 문서화: gRPC 유지 + REST Gateway 추가(기존 `apps/did_service_endpoint` 유지). Swagger(OpenAPI) 자동 산출은 `swag` 주석 기반으로 진행한다.
- 문서 자동화: `make swagger`로 OpenAPI 생성, `make swagger-lint`/`make swagger-docs`로 Redocly 검증/HTML 산출을 지원한다.
- DB 초기화: `LEVELDB_PATH` 환경변수로 LevelDB 경로를 설정하고, 실패 시 `error`를 반환한다(테스트 가능/안전한 실패 처리 목적).
- KMS 재정의: KMS를 탈중앙 서비스가 아닌 내부 서비스용 KMS로 정의하고, 키 생성/보관/서명/복호화 제공자로 한정한다.
- KMS 패키지 분리: KMS 구현을 `pkg/did/kms`로 이동하고, 앱/테스트는 해당 패키지를 직접 사용한다.
- 키 유틸 분리: RSA/ECDSA 유틸을 `did/pkg/keys`로 이동하고 `dkms`는 해당 패키지만 의존하도록 정리한다.
- 키 접근 제한: KMS의 raw key 접근은 typed getter(`PvKeyRSA/PvKeyECDSA`) 사용으로 제한하고 직접 캐스팅은 제거한다.
- KMS 외부 API: 서명/검증은 `Signer/Verifier` 인터페이스로 노출하며, 호출자는 base58 키 직접 접근 없이 `kms.Sign`/`kms.Verify` 사용.
- 암복호화 캡슐화(부분): KMS에 `Encrypt/Decrypt`를 제공하고, 핵심 플로우에서 우선 적용한다.
- core API 에러 표준화: `pkg/did/errors`에 코드 기반 에러를 정의하고, controller 레이어에서 우선 적용한다.
- Registry 스토리지 분리: `pkg/did/registry`에 Store 인터페이스와 LevelDB 구현을 둔다.

## 테스트/커버리지 실행
- 단위 테스트: `make unit-test`
- 통합 테스트: `make integration-test`
- 커버리지 기준: `make coverage-did` (95% 미만이면 실패)

## 로컬 실행 (dev-up/dev-down)
- 환경변수: `.env`에 `ETH_PRIVATE_KEY_HEX` 필수.
- 실행: `make dev-up`
  - 순서: `DID-Registry` → `DID-SEP` → `demo-issuer` → `demo-rp` → `demo-client`(시나리오 실행).
  - 로그: `.devlogs/*.log`
- 포트 충돌 엄격 모드: `DEV_UP_STRICT_PORTS=1 make dev-up` (사용 중인 포트가 있으면 실패)
- 중지: `make dev-down`
- 상태 확인: `make dev-status` (pid/포트 점검)
